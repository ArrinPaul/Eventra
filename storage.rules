rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isValidImageSize() {
      return request.resource.size < 5 * 1024 * 1024; // 5MB
    }
    
    function isValidFileSize() {
      return request.resource.size < 25 * 1024 * 1024; // 25MB
    }
    
    function isImageFile() {
      return request.resource.contentType.matches('image/.*');
    }
    
    function isVideoFile() {
      return request.resource.contentType.matches('video/.*');
    }
    
    function isDocumentFile() {
      return request.resource.contentType.matches('application/pdf') ||
             request.resource.contentType.matches('application/msword') ||
             request.resource.contentType.matches('application/vnd.openxmlformats-officedocument.*') ||
             request.resource.contentType.matches('text/plain') ||
             request.resource.contentType.matches('application/json') ||
             request.resource.contentType.matches('application/xml');
    }
    
    function isAudioFile() {
      return request.resource.contentType.matches('audio/.*');
    }
    
    function isValidAudioSize() {
      return request.resource.size < 10 * 1024 * 1024; // 10MB for audio
    }
    
    function isValidCertificateFile() {
      return (request.resource.contentType.matches('application/pdf') ||
              request.resource.contentType.matches('image/.*')) &&
             request.resource.size < 15 * 1024 * 1024; // 15MB for certificates
    }
    
    function isValidNotationFile() {
      return (isImageFile() || isDocumentFile()) && 
             request.resource.size < 25 * 1024 * 1024; // 25MB for notation attachments
    }
    
    function isValidQRCodeSize() {
      return request.resource.size < 1 * 1024 * 1024; // 1MB for QR codes
    }

    // User profile images
    match /profile-images/{userId}/{imageId} {
      allow read: if true;
      allow write: if isAuthenticated() && 
                      isOwner(userId) && 
                      isImageFile() && 
                      isValidImageSize();
    }

    // Community images and banners
    match /community-images/{communityId}/{imageId} {
      allow read: if true;
      allow write: if isAuthenticated() && 
                      isImageFile() && 
                      isValidImageSize();
    }

    // Event images and media
    match /event-images/{eventId}/{imageId} {
      allow read: if true;
      allow write: if isAuthenticated() && 
                      isImageFile() && 
                      request.resource.size < 10 * 1024 * 1024; // 10MB for events
    }

    // Group resources (documents, images, videos)
    match /group-resources/{groupId}/{resourceId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                      isValidFileSize() &&
                      (isImageFile() || isVideoFile() || isDocumentFile());
    }

    // Chat attachments
    match /chat-attachments/{roomId}/{messageId}/{attachmentId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                      request.resource.size < 15 * 1024 * 1024 && // 15MB
                      (isImageFile() || isVideoFile() || isDocumentFile());
    }

    // Feed post media (images and videos)
    match /feed-media/{postId}/{mediaId} {
      allow read: if true;
      allow write: if isAuthenticated() && 
                      request.resource.size < 20 * 1024 * 1024 && // 20MB
                      (isImageFile() || isVideoFile());
    }

    // User business cards and networking materials
    match /networking-materials/{userId}/{materialId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                      isOwner(userId) && 
                      (isImageFile() || isDocumentFile()) &&
                      isValidImageSize();
    }

    // Event QR codes and tickets (system generated)
    match /ticket-assets/{eventId}/{assetId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only server can generate ticket assets
    }

    // Gamification badges and achievement icons
    match /gamification-assets/{assetId} {
      allow read: if true;
      allow write: if false; // Only admin/system can upload
    }

    // Temporary uploads folder (auto-cleanup after 24h)
    match /temp-uploads/{userId}/{uploadId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if isAuthenticated() && 
                      isOwner(userId) && 
                      isValidFileSize();
    }

    // System assets (logos, backgrounds, etc.) - read-only for users
    match /system-assets/{assetId} {
      allow read: if true;
      allow write: if false; // Only admin can manage
    }

    // Backup and export files - admin only
    match /exports/{exportId} {
      allow read: if false; // Only admin through functions
      allow write: if false;
    }

    // ========== VIBEATHON PLATFORM ENHANCED STORAGE ==========
    
    // Notation System Attachments
    match /notation-attachments/{documentId}/{attachmentId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isValidNotationFile();
    }
    
    // Generated Certificates (PDF and Images)
    match /certificates/{userId}/{certificateId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only server generates certificates
    }
    
    // Certificate Templates for Admins
    match /certificate-templates/{templateId}/{assetId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isValidCertificateFile(); // Admins can upload templates
    }
    
    // QR Codes (User Profile and Event Check-in)
    match /qr-codes/{userId}/{qrId} {
      allow read: if true; // Public read for scanning
      allow write: if false; // Only server generates QR codes
    }
    
    // Event QR Codes for Check-ins
    match /event-qr-codes/{eventId}/{qrId} {
      allow read: if true; // Public read for event check-ins
      allow write: if false; // Only server generates event QR codes
    }
    
    // Digital Business Cards
    match /business-cards/{userId}/{assetId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                      isOwner(userId) && 
                      isImageFile() && 
                      isValidImageSize();
    }
    
    // Business Card Exports (PDF, VCard)
    match /business-card-exports/{userId}/{exportId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if false; // Only server generates exports
    }
    
    // AI Chat Voice Recordings
    match /ai-chat-voice/{userId}/{sessionId}/{recordingId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if isAuthenticated() && 
                      isOwner(userId) && 
                      isAudioFile() && 
                      isValidAudioSize();
    }
    
    // AI Chat File Uploads
    match /ai-chat-uploads/{userId}/{sessionId}/{fileId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if isAuthenticated() && 
                      isOwner(userId) && 
                      (isImageFile() || isDocumentFile()) && 
                      isValidFileSize();
    }
    
    // N8N Workflow Assets and Attachments
    match /workflow-assets/{workflowId}/{assetId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                      (isImageFile() || isDocumentFile()) && 
                      request.resource.size < 50 * 1024 * 1024; // 50MB for workflow files
    }
    
    // Scraped Event Media (Read-only for users)
    match /scraped-media/{sourceId}/{mediaId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only scraper service can write
    }
    
    // User Data Exports (GDPR Compliance)
    match /user-exports/{userId}/{exportId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if false; // Only server generates user exports
    }
    
    // WhatsApp Media (Profile Pictures, Attachments)
    match /whatsapp-media/{userId}/{mediaId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if false; // Only WhatsApp service can store media
    }
    
    // Google Workspace Sync Cache (Thumbnails, Previews)
    match /workspace-cache/{userId}/{documentId}/{cacheId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if false; // Only Google Workspace sync service can write
    }
    
    // Professional Portfolio Assets
    match /portfolio-assets/{userId}/{assetId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                      isOwner(userId) && 
                      (isImageFile() || isVideoFile() || isDocumentFile()) && 
                      request.resource.size < 50 * 1024 * 1024; // 50MB for portfolio files
    }
    
    // Student Project Files and Presentations
    match /student-projects/{userId}/{projectId}/{fileId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                      isOwner(userId) && 
                      (isImageFile() || isVideoFile() || isDocumentFile()) && 
                      request.resource.size < 100 * 1024 * 1024; // 100MB for student projects
    }
    
    // Speaker Resources (Presentations, Handouts)
    match /speaker-resources/{speakerId}/{resourceId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                      isOwner(speakerId) && 
                      (isImageFile() || isVideoFile() || isDocumentFile()) && 
                      request.resource.size < 200 * 1024 * 1024; // 200MB for speaker resources
    }
    
    // Event Organizer Assets
    match /organizer-assets/{organizerId}/{assetId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                      isOwner(organizerId) && 
                      (isImageFile() || isVideoFile() || isDocumentFile()) && 
                      request.resource.size < 100 * 1024 * 1024; // 100MB for organizer assets
    }
    
    // Session Recordings and Live Stream Archives
    match /session-recordings/{eventId}/{sessionId}/{recordingId} {
      allow read: if isAuthenticated(); // Access control handled at app level
      allow write: if false; // Only streaming service can upload recordings
    }
    
    // Security and Audit Files
    match /security-logs/{logId} {
      allow read: if false; // Admin only through server functions
      allow write: if false; // Only server can write security logs
    }
    
    // Backup Files
    match /system-backups/{backupId} {
      allow read: if false; // Admin only through server functions
      allow write: if false; // Only backup service can write
    }
    
    // Temporary Processing Files (Auto-cleanup)
    match /temp-processing/{userId}/{taskId}/{fileId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if isAuthenticated() && 
                      isOwner(userId) && 
                      request.resource.size < 500 * 1024 * 1024; // 500MB for processing
    }
    
    // Analytics and Report Files
    match /analytics-reports/{reportId} {
      allow read: if false; // Admin only through server functions
      allow write: if false; // Only analytics service can generate reports
    }
    
    // Feature Flag Assets and Configuration
    match /feature-assets/{featureId}/{assetId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only admin through server functions
    }
    
    // Default deny rule for unlisted paths
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}