rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(resourceUserId) {
      return request.auth.uid == resourceUserId;
    }
    
    function hasRole(role) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
    
    function isModerator() {
      return hasRole('moderator') || hasRole('admin') || hasRole('organizer');
    }
    
    function isAdmin() {
      return hasRole('admin') || hasRole('organizer');
    }
    
    function isCommunityMember(communityId) {
      return exists(/databases/$(database)/documents/communityMembers/$(communityId + '_' + request.auth.uid));
    }
    
    function isGroupMember(groupId) {
      return exists(/databases/$(database)/documents/groupMembers/$(groupId + '_' + request.auth.uid));
    }
    
    function isChatRoomMember(roomId) {
      return exists(/databases/$(database)/documents/chatRoomMembers/$(roomId + '_' + request.auth.uid));
    }

    // User profiles and authentication
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId);
    }

    // User XP and gamification data
    match /userXP/{userId} {
      allow read: if isAuthenticated() && (isOwner(userId) || isModerator());
      allow write: if false; // Only server can write XP data
    }

    match /userAchievements/{achievementId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only server can award achievements
    }

    match /achievements/{achievementId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /userStreaks/{streakId} {
      allow read: if isAuthenticated() && (isOwner(resource.data.userId) || isModerator());
      allow write: if false; // Only server can update streaks
    }

    match /challenges/{challengeId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /challengeProgress/{progressId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow write: if isOwner(resource.data.userId);
    }

    match /userTitles/{titleId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only server can award titles
    }

    match /feedbackWalls/{wallId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /wallFeedbacks/{feedbackId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.authorId) || isModerator();
      allow delete: if isOwner(resource.data.authorId) || isModerator();
    }

    match /leaderboards/{leaderboardId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only server can update leaderboards
    }

    // Communities and discussions
    match /communities/{communityId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isCommunityMember(communityId) || isModerator();
      allow delete: if isOwner(resource.data.createdBy) || isAdmin();
    }

    match /communityMembers/{memberId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.userId) || isModerator();
      allow delete: if isOwner(resource.data.userId) || isModerator();
    }

    match /discussions/{discussionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isCommunityMember(resource.data.communityId);
      allow update: if isOwner(resource.data.authorId) || isModerator();
      allow delete: if isOwner(resource.data.authorId) || isModerator();
    }

    match /discussionComments/{commentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.authorId) || isModerator();
      allow delete: if isOwner(resource.data.authorId) || isModerator();
    }

    match /commentVotes/{voteId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isOwner(resource.data.userId);
    }

    match /moderationActions/{actionId} {
      allow read: if isModerator();
      allow create: if isModerator();
      allow update: if false;
      allow delete: if false;
    }

    // Chat and messaging
    match /chatRooms/{roomId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isChatRoomMember(roomId) || isModerator();
      allow delete: if isOwner(resource.data.createdBy) || isAdmin();
    }

    match /chatRoomMembers/{memberId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.userId) || isModerator();
      allow delete: if isOwner(resource.data.userId) || isModerator();
    }

    match /chatMessages/{messageId} {
      allow read: if isAuthenticated() && isChatRoomMember(resource.data.roomId);
      allow create: if isAuthenticated() && isChatRoomMember(request.resource.data.roomId);
      allow update: if isOwner(resource.data.senderId) || isModerator();
      allow delete: if isOwner(resource.data.senderId) || isModerator();
    }

    match /directMessages/{messageId} {
      allow read: if isAuthenticated() && 
                     (isOwner(resource.data.senderId) || isOwner(resource.data.recipientId));
      allow create: if isAuthenticated() && isOwner(request.resource.data.senderId);
      allow update: if isOwner(resource.data.senderId);
      allow delete: if isOwner(resource.data.senderId) || isModerator();
    }

    match /conversations/{conversationId} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.participants;
      allow write: if isAuthenticated() && request.auth.uid in request.resource.data.participants;
    }

    // Live feed
    match /feedPosts/{postId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.authorId) || isModerator();
      allow delete: if isOwner(resource.data.authorId) || isModerator();
    }

    match /feedComments/{commentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.authorId) || isModerator();
      allow delete: if isOwner(resource.data.authorId) || isModerator();
    }

    match /feedLikes/{likeId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Professional networking
    match /userProfiles/{profileId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(profileId);
    }

    match /connectionRequests/{requestId} {
      allow read: if isAuthenticated() && 
                     (isOwner(resource.data.fromUserId) || isOwner(resource.data.toUserId));
      allow create: if isAuthenticated() && isOwner(request.resource.data.fromUserId);
      allow update: if isOwner(resource.data.toUserId) || isModerator();
      allow delete: if isOwner(resource.data.fromUserId) || isModerator();
    }

    match /connections/{connectionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow delete: if isAuthenticated() && 
                       (isOwner(resource.data.userId1) || isOwner(resource.data.userId2));
    }

    // Event ticketing
    match /ticketedEvents/{eventId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.organizerId) || isAdmin();
      allow delete: if isOwner(resource.data.organizerId) || isAdmin();
    }

    match /eventTickets/{ticketId} {
      allow read: if isAuthenticated() && 
                     (isOwner(resource.data.userId) || 
                      isOwner(get(/databases/$(database)/documents/ticketedEvents/$(resource.data.eventId)).data.organizerId) ||
                      isModerator());
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isOwner(resource.data.userId) || isModerator();
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }

    match /ticketTypes/{typeId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                      isOwner(get(/databases/$(database)/documents/ticketedEvents/$(resource.data.eventId)).data.organizerId);
    }

    // Groups and recurring events
    match /groups/{groupId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isGroupMember(groupId) || isModerator();
      allow delete: if isOwner(resource.data.createdBy) || isAdmin();
    }

    match /groupMembers/{memberId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.userId) || isModerator();
      allow delete: if isOwner(resource.data.userId) || isModerator();
    }

    match /groupEvents/{eventId} {
      allow read: if isAuthenticated() && isGroupMember(resource.data.groupId);
      allow create: if isAuthenticated() && isGroupMember(request.resource.data.groupId);
      allow update: if isOwner(resource.data.createdBy) || isModerator();
      allow delete: if isOwner(resource.data.createdBy) || isModerator();
    }

    match /groupDiscussions/{discussionId} {
      allow read: if isAuthenticated() && isGroupMember(resource.data.groupId);
      allow create: if isAuthenticated() && isGroupMember(request.resource.data.groupId);
      allow update: if isOwner(resource.data.authorId) || isModerator();
      allow delete: if isOwner(resource.data.authorId) || isModerator();
    }

    match /groupResources/{resourceId} {
      allow read: if isAuthenticated() && isGroupMember(resource.data.groupId);
      allow create: if isAuthenticated() && isGroupMember(request.resource.data.groupId);
      allow update: if isOwner(resource.data.uploadedBy) || isModerator();
      allow delete: if isOwner(resource.data.uploadedBy) || isModerator();
    }

    // AI Matchmaking
    match /matchmakingProfiles/{profileId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(profileId);
    }

    match /matchmakingRequests/{requestId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow write: if isAuthenticated() && isOwner(resource.data.userId);
    }

    match /teamSuggestions/{suggestionId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow write: if false; // Only server can generate suggestions
    }

    match /compatibilityScores/{scoreId} {
      allow read: if isAuthenticated() && 
                     (request.auth.uid in resource.data.userIds);
      allow write: if false; // Only server can calculate scores
    }

    // Notifications
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if false; // Only server can create notifications
      allow update: if isOwner(resource.data.userId); // For marking as read
      allow delete: if isOwner(resource.data.userId);
    }

    // Analytics (restricted access)
    match /analytics/{document=**} {
      allow read: if isAdmin();
      allow write: if false; // Only server can write analytics
    }

    // Matchmaking System
    match /matches/{matchId} {
      allow read: if isAuthenticated() && 
                     (resource.data.user1Id == request.auth.uid || 
                      resource.data.user2Id == request.auth.uid);
      allow write: if false; // Only server can create matches
    }

    match /swipeActions/{actionId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow write: if false; // Only server can create swipe actions
    }

    match /matchProfiles/{userId} {
      allow read: if isAuthenticated() && (userId == request.auth.uid || isModerator());
      allow write: if isAuthenticated() && userId == request.auth.uid;
      allow create: if isAuthenticated() && userId == request.auth.uid;
    }

    // Scheduled Notifications (admin only)
    match /scheduledNotifications/{notificationId} {
      allow read, write: if isAdmin();
    }

    match /userActions/{actionId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(request.resource.data.userId);
      allow update: if false;
      allow delete: if false;
    }

    // Legacy collections (maintain existing access)
    match /events/{eventId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    match /sessions/{sessionId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    match /eventAttendees/{attendeeId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    match /userSessions/{sessionId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // System collections (admin only)
    match /systemSettings/{settingId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Only server can write audit logs
    }

    // Temporary collections for cleanup
    match /feedCache/{cacheId} {
      allow read: if false;
      allow write: if false; // Only server manages cache
    }

    // ========== NEW VIBEATHON PLATFORM FEATURES ==========
    
    // Notation System (Collaborative Notes)
    match /notationDocuments/{documentId} {
      allow read: if isAuthenticated() && 
                     (resource.data.ownerId == request.auth.uid || 
                      request.auth.uid in resource.data.collaborators ||
                      resource.data.visibility == 'public' ||
                      (resource.data.visibility == 'event' && 
                       exists(/databases/$(database)/documents/eventAttendees/$(resource.data.eventId + '_' + request.auth.uid))));
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isAuthenticated() && 
                       (resource.data.ownerId == request.auth.uid || 
                        request.auth.uid in resource.data.collaborators ||
                        isModerator());
      allow delete: if isAuthenticated() && 
                       (resource.data.ownerId == request.auth.uid || isAdmin());
    }

    match /notationComments/{commentId} {
      allow read: if isAuthenticated() && 
                     exists(/databases/$(database)/documents/notationDocuments/$(resource.data.documentId)) &&
                     (get(/databases/$(database)/documents/notationDocuments/$(resource.data.documentId)).data.ownerId == request.auth.uid ||
                      request.auth.uid in get(/databases/$(database)/documents/notationDocuments/$(resource.data.documentId)).data.collaborators);
      allow create: if isAuthenticated() && request.resource.data.authorId == request.auth.uid;
      allow update: if isAuthenticated() && 
                       (resource.data.authorId == request.auth.uid || isModerator());
      allow delete: if isAuthenticated() && 
                       (resource.data.authorId == request.auth.uid || isModerator());
    }

    match /notationVersions/{versionId} {
      allow read: if isAuthenticated() && 
                     exists(/databases/$(database)/documents/notationDocuments/$(resource.data.documentId)) &&
                     (get(/databases/$(database)/documents/notationDocuments/$(resource.data.documentId)).data.ownerId == request.auth.uid ||
                      request.auth.uid in get(/databases/$(database)/documents/notationDocuments/$(resource.data.documentId)).data.collaborators);
      allow create: if false; // Only server can create versions
      allow update: if false;
      allow delete: if isAuthenticated() && 
                       get(/databases/$(database)/documents/notationDocuments/$(resource.data.documentId)).data.ownerId == request.auth.uid;
    }

    // N8N Automation Workflows
    match /n8nWorkflows/{workflowId} {
      allow read: if isAuthenticated() && 
                     (resource.data.ownerId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isAuthenticated() && 
                       (resource.data.ownerId == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() && 
                       (resource.data.ownerId == request.auth.uid || isAdmin());
    }

    match /n8nWorkflowExecutions/{executionId} {
      allow read: if isAuthenticated() && 
                     (resource.data.ownerId == request.auth.uid || isAdmin());
      allow create: if false; // Only server can create executions
      allow update: if false; // Only server can update executions
      allow delete: if isAdmin();
    }

    match /n8nWebhooks/{webhookId} {
      allow read: if isAuthenticated() && 
                     (resource.data.ownerId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isAuthenticated() && 
                       (resource.data.ownerId == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() && 
                       (resource.data.ownerId == request.auth.uid || isAdmin());
    }

    // Web Scraper Data
    match /scrapedEvents/{eventId} {
      allow read: if isAuthenticated();
      allow create: if false; // Only server can create scraped events
      allow update: if false; // Only server can update scraped events
      allow delete: if isAdmin();
    }

    match /scrapingJobs/{jobId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update: if false; // Only server can update job status
      allow delete: if isAdmin();
    }

    match /eventSources/{sourceId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // AI Chatbot Conversations
    match /aiChatSessions/{sessionId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /aiChatMessages/{messageId} {
      allow read: if isAuthenticated() && 
                     exists(/databases/$(database)/documents/aiChatSessions/$(resource.data.sessionId)) &&
                     get(/databases/$(database)/documents/aiChatSessions/$(resource.data.sessionId)).data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
                       exists(/databases/$(database)/documents/aiChatSessions/$(request.resource.data.sessionId)) &&
                       get(/databases/$(database)/documents/aiChatSessions/$(request.resource.data.sessionId)).data.userId == request.auth.uid;
      allow update: if false; // Messages are immutable
      allow delete: if isAuthenticated() && 
                       exists(/databases/$(database)/documents/aiChatSessions/$(resource.data.sessionId)) &&
                       get(/databases/$(database)/documents/aiChatSessions/$(resource.data.sessionId)).data.userId == request.auth.uid;
    }

    match /aiKnowledgeBase/{articleId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Certificates System
    match /certificateTemplates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || hasRole('organizer');
    }

    match /userCertificates/{certificateId} {
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || 
                      resource.data.issuerId == request.auth.uid ||
                      resource.data.visibility == 'public' ||
                      isAdmin());
      allow create: if false; // Only server can issue certificates
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid; // For sharing settings
      allow delete: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
    }

    match /certificateValidation/{validationId} {
      allow read: if true; // Public validation
      allow write: if false; // Only server can create/update validations
    }

    // User Management Enhancements
    match /userQRCodes/{userId} {
      allow read: if isAuthenticated() && 
                     (userId == request.auth.uid || isModerator());
      allow write: if isAuthenticated() && userId == request.auth.uid;
    }

    match /qrCodeScans/{scanId} {
      allow read: if isAuthenticated() && 
                     (resource.data.scannedBy == request.auth.uid || 
                      resource.data.scannedUserId == request.auth.uid ||
                      isModerator());
      allow create: if isAuthenticated() && request.resource.data.scannedBy == request.auth.uid;
      allow update: if false;
      allow delete: if isAuthenticated() && 
                       (resource.data.scannedBy == request.auth.uid || isAdmin());
    }

    match /whatsappNotifications/{notificationId} {
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if false; // Only server can create WhatsApp notifications
      allow update: if false;
      allow delete: if isAdmin();
    }

    match /phoneVerifications/{verificationId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Google Workspace Integration
    match /eventDocuments/{documentId} {
      allow read: if isAuthenticated() && 
                     (request.auth.uid in resource.data.collaborators ||
                      resource.data.createdBy == request.auth.uid ||
                      isModerator());
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                       (request.auth.uid in resource.data.collaborators ||
                        resource.data.createdBy == request.auth.uid ||
                        isModerator());
      allow delete: if isAuthenticated() && 
                       (resource.data.createdBy == request.auth.uid || isAdmin());
    }

    match /eventSpreadsheets/{spreadsheetId} {
      allow read: if isAuthenticated() && 
                     (request.auth.uid in resource.data.collaborators ||
                      resource.data.createdBy == request.auth.uid ||
                      isModerator());
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                       (request.auth.uid in resource.data.collaborators ||
                        resource.data.createdBy == request.auth.uid ||
                        isModerator());
      allow delete: if isAuthenticated() && 
                       (resource.data.createdBy == request.auth.uid || isAdmin());
    }

    match /googleWorkspaceSync/{syncId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow write: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Event Check-ins and Attendance Tracking
    match /eventCheckIns/{checkinId} {
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid ||
                      get(/databases/$(database)/documents/events/$(resource.data.eventId)).data.organizerId == request.auth.uid ||
                      isModerator());
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if false; // Check-ins are immutable
      allow delete: if isAdmin();
    }

    match /attendanceAnalytics/{eventId} {
      allow read: if isAuthenticated() && 
                     (get(/databases/$(database)/documents/events/$(eventId)).data.organizerId == request.auth.uid ||
                      isAdmin());
      allow write: if false; // Only server can update analytics
    }

    // Enhanced User Profiles for Role-Based Access
    match /studentProfiles/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && userId == request.auth.uid;
    }

    match /professionalProfiles/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && userId == request.auth.uid;
    }

    match /speakerProfiles/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && userId == request.auth.uid;
    }

    match /organizerProfiles/{userId} {
      allow read: if isAuthenticated() && (userId == request.auth.uid || isModerator());
      allow write: if isAuthenticated() && userId == request.auth.uid;
    }

    // Business Cards and Professional Networking
    match /digitalBusinessCards/{cardId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
    }

    match /businessCardShares/{shareId} {
      allow read: if isAuthenticated() && 
                     (resource.data.sharedBy == request.auth.uid ||
                      resource.data.sharedWith == request.auth.uid);
      allow create: if isAuthenticated() && request.resource.data.sharedBy == request.auth.uid;
      allow update: if false;
      allow delete: if isAuthenticated() && 
                       (resource.data.sharedBy == request.auth.uid || isAdmin());
    }

    // System Monitoring and Audit Trails
    match /systemHealth/{componentId} {
      allow read: if isAdmin();
      allow write: if false; // Only server can update system health
    }

    match /featureUsageAnalytics/{analyticsId} {
      allow read: if isAdmin();
      allow write: if false; // Only server can track feature usage
    }

    match /securityIncidents/{incidentId} {
      allow read: if isAdmin();
      allow write: if false; // Only server can log security incidents
    }

    // Rate Limiting and Abuse Prevention
    match /rateLimiting/{userId} {
      allow read: if false; // Internal use only
      allow write: if false; // Only server can manage rate limits
    }

    match /userReports/{reportId} {
      allow read: if isModerator();
      allow create: if isAuthenticated() && request.resource.data.reportedBy == request.auth.uid;
      allow update: if isModerator();
      allow delete: if isAdmin();
    }

    // Default deny rule for any unlisted collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

// Storage rules for file uploads
service firebase.storage {
  match /b/{bucket}/o {
    // User profile images
    match /profile-images/{userId}/{imageId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId &&
                      request.resource.size < 5 * 1024 * 1024 && // 5MB limit
                      request.resource.contentType.matches('image/.*');
    }

    // Community images
    match /community-images/{communityId}/{imageId} {
      allow read: if true;
      allow write: if request.auth != null &&
                      request.resource.size < 10 * 1024 * 1024 && // 10MB limit
                      request.resource.contentType.matches('image/.*');
    }

    // Event images
    match /event-images/{eventId}/{imageId} {
      allow read: if true;
      allow write: if request.auth != null &&
                      request.resource.size < 10 * 1024 * 1024 && // 10MB limit
                      request.resource.contentType.matches('image/.*');
    }

    // Group resources
    match /group-resources/{groupId}/{resourceId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                      request.resource.size < 25 * 1024 * 1024; // 25MB limit for resources
    }

    // Chat attachments
    match /chat-attachments/{roomId}/{messageId}/{attachmentId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                      request.resource.size < 15 * 1024 * 1024; // 15MB limit for attachments
    }

    // Feed post media
    match /feed-media/{postId}/{mediaId} {
      allow read: if true;
      allow write: if request.auth != null &&
                      request.resource.size < 20 * 1024 * 1024 && // 20MB limit
                      (request.resource.contentType.matches('image/.*') ||
                       request.resource.contentType.matches('video/.*'));
    }

    // ========== NEW VIBEATHON PLATFORM STORAGE ==========
    
    // Notation System Attachments
    match /notation-attachments/{documentId}/{attachmentId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                      request.resource.size < 25 * 1024 * 1024 && // 25MB limit
                      (request.resource.contentType.matches('image/.*') ||
                       request.resource.contentType.matches('application/pdf') ||
                       request.resource.contentType.matches('application/.*') ||
                       request.resource.contentType.matches('text/.*'));
    }

    // Certificate Files (PDFs and Images)
    match /certificates/{userId}/{certificateId} {
      allow read: if request.auth != null;
      allow write: if false; // Only server can generate certificates
    }

    // Certificate Templates
    match /certificate-templates/{templateId}/{fileId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                      request.resource.size < 10 * 1024 * 1024 && // 10MB limit
                      (request.resource.contentType.matches('image/.*') ||
                       request.resource.contentType.matches('application/pdf'));
    }

    // QR Code Images
    match /qr-codes/{userId}/{qrId} {
      allow read: if true; // Public read for QR scanning
      allow write: if false; // Only server can generate QR codes
    }

    // Business Card Assets
    match /business-cards/{userId}/{assetId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId &&
                      request.resource.size < 5 * 1024 * 1024 && // 5MB limit
                      request.resource.contentType.matches('image/.*');
    }

    // Digital Business Card Exports
    match /business-card-exports/{userId}/{exportId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // Only server can generate exports
    }

    // AI Chat Attachments
    match /ai-chat-uploads/{userId}/{sessionId}/{fileId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId &&
                      request.resource.size < 15 * 1024 * 1024 && // 15MB limit
                      (request.resource.contentType.matches('image/.*') ||
                       request.resource.contentType.matches('application/pdf') ||
                       request.resource.contentType.matches('text/.*'));
    }

    // Voice Recordings for AI Chat
    match /ai-chat-voice/{userId}/{sessionId}/{recordingId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId &&
                      request.resource.size < 10 * 1024 * 1024 && // 10MB limit
                      request.resource.contentType.matches('audio/.*');
    }

    // Exported Data (GDPR Compliance)
    match /user-data-exports/{userId}/{exportId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // Only server can generate exports
    }

    // Backup Files
    match /backups/{backupId}/{fileId} {
      allow read: if false; // Admin only access handled by server
      allow write: if false; // Only server can create backups
    }

    // System Logs and Monitoring Files
    match /system-logs/{logType}/{logId} {
      allow read: if false; // Admin only access handled by server
      allow write: if false; // Only server can write logs
    }

    // Scraped Event Images and Media
    match /scraped-content/{sourceId}/{contentId} {
      allow read: if request.auth != null;
      allow write: if false; // Only server can store scraped content
    }

    // Workflow Attachments for N8N
    match /workflow-files/{workflowId}/{fileId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                      request.resource.size < 50 * 1024 * 1024 && // 50MB limit for workflow files
                      (request.resource.contentType.matches('application/.*') ||
                       request.resource.contentType.matches('text/.*') ||
                       request.resource.contentType.matches('image/.*'));
    }

    // Temporary Files (24-hour expiry handled by server)
    match /temp/{userId}/{tempId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId &&
                      request.resource.size < 100 * 1024 * 1024; // 100MB limit for temp files
    }

    // Google Workspace Synchronized Files (Thumbnails, Previews)
    match /workspace-sync/{userId}/{documentId}/{fileId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // Only server can sync from Google Workspace
    }

    // Default deny for other paths
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}